<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroClima Preditivo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS (para o mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 400px;
            border-radius: 0.5rem;
        }
        .leaflet-container {
            background-color: #f0f9ff;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-green-700">AgroClima Preditivo</h1>
            <p class="text-lg text-gray-600 mt-2">Análises climáticas para uma agricultura mais resiliente.</p>
        </header>

        <!-- Seção Principal -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Coluna de Controles -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">1. Selecione a Localização</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="state-select" class="block text-sm font-medium text-gray-700">Estado</label>
                        <select id="state-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                            <option>Carregando estados...</option>
                        </select>
                    </div>
                    <div>
                        <label for="city-select" class="block text-sm font-medium text-gray-700">Município</label>
                        <select id="city-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" disabled>
                            <option>Selecione um estado</option>
                        </select>
                    </div>
                </div>

                <div id="map" class="mt-6 shadow-inner"></div>
                
                <h2 class="text-2xl font-bold mb-4 mt-6 border-b pb-2">2. Selecione a Cultura</h2>
                <div class="space-y-4">
                    <div>
                        <label for="crop-select" class="block text-sm font-medium text-gray-700">Cultura Agrícola</label>
                        <select id="crop-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                            <option value="milho">Milho</option>
                            <option value="soja">Soja</option>
                            <option value="cafe">Café</option>
                            <option value="feijao">Feijão</option>
                        </select>
                    </div>
                </div>
                
                <button id="analyze-button" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg flex items-center justify-center" disabled>
                    <i class="fas fa-chart-line mr-2"></i>
                    Analisar Clima
                </button>

            </div>

            <!-- Coluna de Resultados -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Resultados da Análise</h2>
                <div id="results-container" class="space-y-6">
                    <!-- O conteúdo será inserido dinamicamente aqui -->
                    <div id="initial-message" class="text-center py-16 px-4 bg-gray-100 rounded-lg">
                        <i class="fas fa-map-marked-alt text-5xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700">Aguardando sua seleção</h3>
                        <p class="text-gray-500">Escolha um local e uma cultura para iniciar a análise preditiva.</p>
                    </div>
                    <div id="loader-container" class="hidden text-center py-16 px-4">
                         <div class="loader mx-auto"></div>
                         <p class="mt-4 text-lg font-semibold text-gray-600">Analisando dados históricos e previsões... Isso pode levar um momento.</p>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        // ATENÇÃO: Insira sua chave de API do Visual Crossing aqui.
        // Você pode obter uma chave gratuita em: https://www.visualcrossing.com/weather-api
        const VISUAL_CROSSING_API_KEY = '6W4FTRGDCXPJF778TEPXRYAVE';

        // --- ELEMENTOS DO DOM ---
        const stateSelect = document.getElementById('state-select');
        const citySelect = document.getElementById('city-select');
        const cropSelect = document.getElementById('crop-select');
        const analyzeButton = document.getElementById('analyze-button');
        const resultsContainer = document.getElementById('results-container');
        const initialMessage = document.getElementById('initial-message');
        const loaderContainer = document.getElementById('loader-container');
        
        let map;
        let marker;
        let citiesData = [];
        let selectedCity = null;

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeMap();
            await loadStates();
        });

        // --- FUNÇÕES DO MAPA (LEAFLET) ---
        function initializeMap() {
            map = L.map('map').setView([-14.235, -51.925], 4); // Centro do Brasil
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function updateMap(lat, lon, cityName) {
            map.setView([lat, lon], 10);
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`<b>${cityName}</b>`)
                .openPopup();
        }

        // --- CARREGAMENTO DE DADOS DE LOCALIZAÇÃO ---
        async function loadStates() {
            try {
                // Fonte de dados de municípios brasileiros: https://github.com/kelvins/Municipios-Brasileiros
                const responseEstados = await fetch('https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/json/estados.json');
                if (!responseEstados.ok) throw new Error('Falha ao carregar municípios');
                statesData = await responseEstados.json();
                const responseMunicipios = await fetch('https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/json/municipios.json');
                if (!responseMunicipios.ok) throw new Error('Falha ao carregar municípios');
                citiesData = await responseMunicipios.json();
                const states = statesData.sort((a, b) => a.nome.localeCompare(b.nome));
                const stateSelect = document.getElementById('state-select');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.codigo_uf;
                    option.textContent = state.nome;
                    stateSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar estados:", error);
                stateSelect.innerHTML = '<option>Erro ao carregar</option>';
            }
        }
        
        stateSelect.addEventListener('change', () => {
            const selectedState = stateSelect.value;
            console.log("Estado selecionado:", selectedState);
            citySelect.innerHTML = '<option value="">Selecione um município</option>';
            citySelect.disabled = true;
            analyzeButton.disabled = true;
            if (selectedState) {
                const citiesInState = citiesData
                    .filter(city => city.codigo_uf == selectedState)
                    .sort((a, b) => a.nome.localeCompare(b.nome));
                console.log("Cidades no estado selecionado:", citiesInState);
                citiesInState.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.codigo_ibge;
                    option.textContent = city.nome;
                    citySelect.appendChild(option);
                });
                citySelect.disabled = false;
            }
        });

        citySelect.addEventListener('change', () => {
            const cityCode = citySelect.value;
            if (cityCode) {
                selectedCity = citiesData.find(c => c.codigo_ibge == cityCode);
                if (selectedCity) {
                    updateMap(selectedCity.latitude, selectedCity.longitude, selectedCity.nome);
                    analyzeButton.disabled = false;
                }
            } else {
                selectedCity = null;
                analyzeButton.disabled = true;
            }
        });

        // --- LÓGICA DE ANÁLISE ---
        analyzeButton.addEventListener('click', async () => {
            if (!selectedCity) {
                alert('Por favor, selecione um município.');
                return;
            }
            if (VISUAL_CROSSING_API_KEY === 'YOUR_API_KEY') {
                alert('Chave de API do Visual Crossing não configurada. Por favor, edite o código e insira sua chave.');
                return;
            }

            initialMessage.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            resultsContainer.innerHTML = ''; // Limpa resultados antigos
            resultsContainer.appendChild(loaderContainer);

            try {
                // 1. Obter dados históricos da NASA POWER
                const historicalData = await getHistoricalData(selectedCity.latitude, selectedCity.longitude);
                
                // 2. Obter previsão do Visual Crossing
                const forecastData = await getForecastData(selectedCity.latitude, selectedCity.longitude);

                // 3. Rodar o algoritmo de análise (simplificado para o protótipo)
                const analysis = runPredictiveAnalysis(historicalData, forecastData, cropSelect.value);

                // 4. Exibir os resultados
                displayResults(analysis);

            } catch (error) {
                console.error("Erro na análise completa:", error);
                displayError(error.message);
            } finally {
                loaderContainer.classList.add('hidden');
            }
        });
        
        // --- FUNÇÕES DE API ---
        async function getHistoricalData(lat, lon) {
            // Para o hackathon, vamos buscar dados do último ano como exemplo.
            const today = new Date();
            const endDate = today.toISOString().slice(0, 10).replace(/-/g, '');
            const startDate = new Date(today.setFullYear(today.getFullYear() - 1)).toISOString().slice(0, 10).replace(/-/g, '');

            const params = 'T2M_MAX,T2M_MIN,PRECTOTCORR'; // Temp Max, Temp Min, Precipitação
            const url = `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=${params}&community=AG&longitude=${lon}&latitude=${lat}&start=${startDate}&end=${endDate}&format=JSON`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Falha ao buscar dados históricos da NASA POWER.');
            return await response.json();
        }

        async function getForecastData(lat, lon) {
            // Previsão para os próximos 15 dias.
            const url = `https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${lat},${lon}?unitGroup=metric&key=${VISUAL_CROSSING_API_KEY}&contentType=json`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Falha ao buscar previsão do tempo do Visual Crossing.');
            return await response.json();
        }

        // --- ALGORITMO PREDITIVO (SIMPLIFICADO) ---
        function runPredictiveAnalysis(historical, forecast, crop) {
            // ATENÇÃO: Esta é uma lógica muito simplificada para fins de demonstração.
            // Um projeto real exigiria modelos agronômicos complexos.
            
            // Lógica para janela de plantio:
            // Procura o primeiro dia na previsão com chuva > 5mm,
            // e verifica se os 3 dias seguintes também têm alguma chuva.
            let plantingWindowStart = null;
            for (let i = 0; i < forecast.days.length - 3; i++) {
                const day = forecast.days[i];
                if (day.precip > 5) { // Mais de 5mm de chuva
                    const next3days = forecast.days.slice(i + 1, i + 4);
                    if (next3days.every(d => d.precip > 1)) { // Chuva nos próximos 3 dias
                        plantingWindowStart = new Date(day.datetimeEpoch * 1000);
                        break;
                    }
                }
            }

            // Lógica para riscos:
            const risks = [];
            const avgMaxTemp = Object.values(historical.properties.parameter.T2M_MAX).reduce((a, b) => a + b, 0) / 365;
            const hotDays = forecast.days.filter(d => d.tempmax > avgMaxTemp + 5).length;
            if (hotDays > 3) {
                risks.push({
                    type: 'Calor Extremo',
                    description: `Previsão de ${hotDays} dias com temperatura 5°C acima da média histórica anual.`,
                    icon: 'fa-temperature-high',
                    color: 'red'
                });
            }

            const drySpells = forecast.days.filter(d => d.precip < 1).length;
            if(drySpells > 7) {
                 risks.push({
                    type: 'Risco de Seca',
                    description: `Previsão de ${drySpells} dias consecutivos com chuva mínima ou nula.`,
                    icon: 'fa-sun',
                    color: 'orange'
                });
            }

            return { historical, forecast, crop, plantingWindowStart, risks };
        }

        // --- EXIBIÇÃO DE RESULTADOS ---
        function displayResults(analysis) {
            resultsContainer.innerHTML = ''; // Limpa o loader

            const { plantingWindowStart, risks, historical, forecast, crop } = analysis;
            
            let html = `<h3 class="text-2xl font-bold">Análise para ${selectedCity.nome} - ${cropSelect.options[cropSelect.selectedIndex].text}</h3>`;

            // Card de Recomendação
            html += `
                <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-r-lg shadow">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-seedling fa-2x mr-4"></i></div>
                        <div>
                            <p class="font-bold">Janela de Plantio Recomendada</p>
                            <p>${plantingWindowStart ? `A partir de <strong>${plantingWindowStart.toLocaleDateString('pt-BR')}</strong>, com base na previsão de chuvas.` : 'Não foi encontrada uma janela de plantio ideal nos próximos 15 dias.'}</p>
                        </div>
                    </div>
                </div>
            `;

            // Card de Riscos
            if (risks.length > 0) {
                html += `<h4 class="text-xl font-bold mt-6">Alertas de Risco</h4>`;
                risks.forEach(risk => {
                    html += `
                    <div class="bg-${risk.color}-100 border-l-4 border-${risk.color}-500 text-${risk.color}-800 p-4 mt-2 rounded-r-lg shadow">
                        <div class="flex">
                            <div class="py-1"><i class="fas ${risk.icon} fa-2x mr-4"></i></div>
                            <div>
                                <p class="font-bold">${risk.type}</p>
                                <p>${risk.description}</p>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            // Gráficos
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <h4 class="text-xl font-bold mb-2 text-center">Previsão de Precipitação (mm)</h4>
                            <canvas id="precipitationChart"></canvas>
                        </div>
                        <div>
                            <h4 class="text-xl font-bold mb-2 text-center">Previsão de Temperatura (°C)</h4>
                            <canvas id="temperatureChart"></canvas>
                        </div>
                     </div>`;
            
            resultsContainer.innerHTML = html;

            // Renderizar Gráficos
            createPrecipitationChart(forecast.days);
            createTemperatureChart(forecast.days);
        }

        function displayError(message) {
            resultsContainer.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-6 rounded-r-lg shadow">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-exclamation-triangle fa-2x mr-4"></i></div>
                        <div>
                            <p class="font-bold">Ocorreu um Erro</p>
                            <p>${message}</p>
                            <p class="mt-2 text-sm">Verifique sua chave de API ou tente novamente mais tarde.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createPrecipitationChart(forecastDays) {
            const ctx = document.getElementById('precipitationChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: forecastDays.map(d => new Date(d.datetimeEpoch * 1000).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})),
                    datasets: [{
                        label: 'Precipitação (mm)',
                        data: forecastDays.map(d => d.precip),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function createTemperatureChart(forecastDays) {
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecastDays.map(d => new Date(d.datetimeEpoch * 1000).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})),
                    datasets: [
                        {
                            label: 'Máxima (°C)',
                            data: forecastDays.map(d => d.tempmax),
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Mínima (°C)',
                            data: forecastDays.map(d => d.tempmin),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                }
            });
        }

    </script>
</body>
</html>
